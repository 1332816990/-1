import streamlit as st
from openai import OpenAI


# --- 1. Streamlit ç”¨æˆ·ç•Œé¢ ---

def main():
    # è®¾ç½®é¡µé¢é…ç½®
    st.set_page_config(
        page_title="AIçŸ­è§†é¢‘è„šæœ¬ç”Ÿæˆå™¨",
        page_icon="ğŸ¬",
        layout="wide",
        initial_sidebar_state="expanded",
    )

    # é¡µé¢æ ‡é¢˜
    st.title("ğŸ¬ AIçŸ­è§†é¢‘è„šæœ¬ç”Ÿæˆå™¨")
    st.markdown("---")

    # --- 2. ä¾§è¾¹æ ï¼šAPIå¯†é’¥è¾“å…¥ ---
    with st.sidebar:
        st.header("ğŸ”‘ API å¯†é’¥è®¾ç½®")
        st.markdown("è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„ OpenAI API å¯†é’¥ã€‚å¯†é’¥ä»…åœ¨æœ¬æ¬¡ä¼šè¯ä¸­æœ‰æ•ˆï¼Œä¸ä¼šè¢«ä¿å­˜ã€‚")

        # ä½¿ç”¨å¯†ç è¾“å…¥æ¡†ï¼Œè¾“å…¥å†…å®¹ä¼šæ˜¾ç¤ºä¸ºæ˜Ÿå·
        api_key_input = st.text_input(
            "OpenAI API Key",
            type="password",
            placeholder="sk-...",
            help="æ‚¨å¯ä»¥åœ¨ OpenAI å®˜ç½‘çš„ 'View API keys' é¡µé¢æ‰¾åˆ°æ‚¨çš„å¯†é’¥ã€‚"
        )

        # å½“ç”¨æˆ·è¾“å…¥å¯†é’¥å¹¶æŒ‰ä¸‹å›è½¦é”®æˆ–å¤±å»ç„¦ç‚¹æ—¶ï¼Œå°†å…¶å­˜å…¥ session_state
        if api_key_input:
            st.session_state.api_key = api_key_input
            st.success("API å¯†é’¥å·²è®¾ç½®æˆåŠŸï¼")

    # --- 3. ä¸»ç•Œé¢ï¼šè¾“å…¥å’Œè¾“å‡º ---
    # åˆ›å»ºä¸¤åˆ—å¸ƒå±€
    col1, col2 = st.columns(2)

    # å·¦ä¾§ï¼šè¾“å…¥åŒº
    with col1:
        st.header("ğŸ“ è¾“å…¥ä½ çš„æƒ³æ³•")
        topic = st.text_input("è§†é¢‘ä¸»é¢˜", placeholder="ä¾‹å¦‚ï¼š5åˆ†é’Ÿå¿«é€Ÿå‡ºé—¨å¦†")
        style = st.selectbox("è§†é¢‘é£æ ¼", ["å¹½é»˜æç¬‘", "å¹²è´§æ•™å­¦", "æƒ…æ„Ÿå…±é¸£", "ç”Ÿæ´»æ—¥å¸¸", "æ¢åº—æµ‹è¯„"])

        generate_button = st.button("ğŸš€ å¼€å§‹ç”Ÿæˆè„šæœ¬")

    # å³ä¾§ï¼šè¾“å‡ºåŒº
    with col2:
        st.header("ğŸ­ ç”Ÿæˆçš„è„šæœ¬")
        output_container = st.empty()
        output_container.info("è¯·åœ¨å·¦ä¾§è¾“å…¥ä¸»é¢˜å¹¶é€‰æ‹©é£æ ¼ï¼Œç„¶åç‚¹å‡»â€œå¼€å§‹ç”Ÿæˆè„šæœ¬â€æŒ‰é’®ã€‚")

    # --- 4. æ ¸å¿ƒé€»è¾‘ï¼šå¤„ç†ç”Ÿæˆè¯·æ±‚ ---
    if generate_button:
        # æ£€æŸ¥APIå¯†é’¥æ˜¯å¦å·²åœ¨ session_state ä¸­è®¾ç½®
        if "api_key" not in st.session_state or not st.session_state.api_key:
            st.error("âŒ é”™è¯¯ï¼šæœªæ£€æµ‹åˆ° API å¯†é’¥ï¼è¯·åœ¨å·¦ä¾§è¾¹æ ä¸­è¾“å…¥æ‚¨çš„ OpenAI API å¯†é’¥ã€‚")
        elif not topic:
            st.error("âŒ é”™è¯¯ï¼šè§†é¢‘ä¸»é¢˜ä¸èƒ½ä¸ºç©ºï¼")
        else:
            # æ˜¾ç¤ºç”Ÿæˆä¸­çš„çŠ¶æ€
            with st.spinner("AIæ­£åœ¨åŠªåŠ›æ„æ€è„šæœ¬ï¼Œè¯·ç¨å€™..."):
                try:
                    # ä½¿ç”¨ session_state ä¸­çš„å¯†é’¥åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯
                    client = OpenAI(api_key=st.session_state.api_key)

                    # è·å–å®Œæ•´çš„æç¤ºè¯
                    final_prompt = get_prompt_template(topic, style)

                    # è°ƒç”¨AIç”Ÿæˆè„šæœ¬
                    response = client.chat.completions.create(
                        model="gpt-3.5-turbo",
                        messages=[{"role": "user", "content": final_prompt}],
                        temperature=0.7,
                        max_tokens=1500
                    )
                    script = response.choices[0].message.content.strip()

                    # åœ¨å³ä¾§å®¹å™¨ä¸­æ˜¾ç¤ºç”Ÿæˆçš„è„šæœ¬
                    output_container.markdown(script)
                    st.success("âœ… è„šæœ¬ç”Ÿæˆå®Œæˆï¼")

                except Exception as e:
                    # æ•è·å¯èƒ½çš„APIé”™è¯¯ï¼Œä¾‹å¦‚å¯†é’¥æ— æ•ˆã€ç½‘ç»œé—®é¢˜ç­‰
                    output_container.error(
                        f"API è°ƒç”¨å¤±è´¥ã€‚è¯·æ£€æŸ¥æ‚¨çš„ API å¯†é’¥æ˜¯å¦æœ‰æ•ˆæˆ–ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ã€‚\n\né”™è¯¯è¯¦æƒ…: {e}")


# --- 5. å®šä¹‰æç¤ºè¯æ¨¡æ¿ (æ­¤å‡½æ•°ä¸ä¹‹å‰ç›¸åŒ) ---

def get_prompt_template(topic, style):
    """æ ¹æ®ç”¨æˆ·è¾“å…¥ç”Ÿæˆå®Œæ•´çš„æç¤ºè¯"""
    template = f"""
    # è§’è‰²
    ä½ æ˜¯ä¸€ä½èµ„æ·±çš„çŸ­è§†é¢‘å†…å®¹ç­–åˆ’ä¸è„šæœ¬æ’°å†™ä¸“å®¶ï¼Œæ“…é•¿åˆ›ä½œåœ¨æŠ–éŸ³ã€å°çº¢ä¹¦ç­‰å¹³å°ä¸Šæµè¡Œçš„ã€å¼•äººå…¥èƒœçš„çŸ­è§†é¢‘è„šæœ¬ã€‚

    # ä»»åŠ¡
    æ ¹æ®ç”¨æˆ·æä¾›çš„ä¸»é¢˜å’Œé£æ ¼ï¼Œä¸ºå…¶ç”Ÿæˆä¸€ä¸ªæ—¶é•¿çº¦ä¸º60ç§’çš„çŸ­è§†é¢‘è„šæœ¬ã€‚

    # è¦æ±‚
    1.  **è„šæœ¬ç»“æ„**ï¼šè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¾“å‡ºï¼š
        *   **è§†é¢‘æ ‡é¢˜**ï¼šä¸€ä¸ªå¸å¼•äººç‚¹å‡»çš„æ ‡é¢˜ã€‚
        *   **è§†é¢‘é£æ ¼**ï¼šæ€»ç»“è§†é¢‘çš„æ•´ä½“è°ƒæ€§ã€‚
        *   **èƒŒæ™¯éŸ³ä¹å»ºè®®**ï¼šæ¨èé€‚åˆè§†é¢‘é£æ ¼çš„BGMç±»å‹æˆ–æ­Œæ›²ã€‚
        *   **è„šæœ¬å†…å®¹**ï¼šä»¥è¡¨æ ¼å½¢å¼å‘ˆç°ï¼ŒåŒ…å«ã€æ™¯å·ã€‘ã€ã€æ™¯åˆ«ã€‘ã€ã€æ—¶é•¿ã€‘ã€ã€ç”»é¢ã€‘ã€ã€å°è¯/éŸ³æ•ˆã€‘äº”åˆ—ã€‚

    2.  **å†…å®¹è¦æ±‚**ï¼š
        *   **å¼€å¤´3ç§’**ï¼šå¿…é¡»è®¾è®¡ä¸€ä¸ªå¼ºæœ‰åŠ›çš„â€œé»„é‡‘3ç§’â€ã€‚
        *   **è¯­è¨€é£æ ¼**ï¼šå£è¯­åŒ–ã€æœ‰ç½‘æ„Ÿã€‚
        *   **èŠ‚å¥**ï¼šæ˜å¿«ï¼Œä¸æ‹–æ²“ã€‚
        *   **äº’åŠ¨æ€§**ï¼šå¼•å¯¼ç”¨æˆ·ç‚¹èµã€å…³æ³¨æˆ–è¯„è®ºã€‚

    # è¾“å…¥
    1.  **è§†é¢‘ä¸»é¢˜**: {topic}
    2.  **è§†é¢‘é£æ ¼**: {style}

    # è¾“å‡º
    è¯·ç›´æ¥ç”Ÿæˆç¬¦åˆä¸Šè¿°è¦æ±‚çš„çŸ­è§†é¢‘è„šæœ¬ã€‚
    """
    return template


# --- è¿è¡Œåº”ç”¨ ---
if __name__ == "__main__":
    main()
